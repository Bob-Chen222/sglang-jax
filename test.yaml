resources:
  accelerators: tpu-v6e-4
  accelerator_args:
    tpu_vm: true
    runtime_version: v2-alpha-tpuv6e  # optional

file_mounts:
  ~/.ssh/id_rsa: ~/.ssh/id_rsa

setup: |
  chmod 600 ~/.ssh/id_rsa
  rm ~/.ssh/config
  GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
    git clone git@github.com:Bob-Chen222/sglang-jax.git
  cd /home/gcpuser/sky_workdir/sglang-jax
  uv venv --python 3.12 && source .venv/bin/activate && uv pip install -e python/

run: |
  source /home/gcpuser/sky_workdir/sglang-jax/.venv/bin/activate && \
  SGL_JAX_USE_JIT=1 \
  JAX_COMPILATION_CACHE_DIR=/tmp/jax_compilation_cache \
  uv run python -u -m sgl_jax.launch_server \
    --model-path Qwen/Qwen-7B \
    --trust-remote-code \
    --skip-server-warmup \
    --dist-init-addr=0.0.0.0:10011 \
    --nnodes=1 \
    --tp-size=1 \
    --device=tpu \
    --random-seed=3 \
    --node-rank=0 \
    --mem-fraction-static=0.1 \
    --max-prefill-tokens=4096 \
    --download-dir=/tmp/ \
    --kv-cache-dtype=bf16